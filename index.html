async function loadImageFromGitHub(filePath) {
    let fileBlob;
    let fileExtension = filePath.split('.').pop().toLowerCase();

    // Clear previous image and reset state
    imageState.scale = 1;
    imageState.x = 0;
    imageState.y = 0;
    imageState.min = 0;
    imageState.max = 255;
    context.clearRect(0, 0, canvas.width, canvas.height);

    try {
        const githubApiUrl = `https://api.github.com/repos/${githubRepo}/contents/${filePath}?ref=${githubDefaultBranch}`;
        console.log(`Attempting to fetch file from: ${githubApiUrl}`);

        const response = await fetch(githubApiUrl, {
            headers: { 'Authorization': `token ${githubToken}` }
        });

        if (!response.ok) {
            const errorText = await response.text();
            console.error('GitHub API response error:', response.status, response.statusText, errorText);
            throw new Error(`GitHub API error: ${response.status} ${response.statusText}. Please check the repository and file path.`);
        }
        
        const fileData = await response.json();
        const fileContent = atob(fileData.content);

        if (isLfsPointer(fileContent)) {
            showMessage("Fetching Git LFS image...", false);
            const { oid } = parseLfsPointer(fileContent);
            if (!oid) {
                throw new Error('Failed to parse OID from LFS pointer file.');
            }
            console.log(`LFS pointer detected. OID: ${oid}`);
            
            // --- FIX STARTS HERE ---
            // Use a publicly accessible Git LFS API endpoint
            const lfsApiUrl = `https://github.com/${githubRepo}.git/info/lfs/objects/batch`;

            const lfsResponse = await fetch(lfsApiUrl, {
                method: 'POST',
                headers: {
                    'Accept': 'application/vnd.git-lfs+json',
                    'Content-Type': 'application/vnd.git-lfs+json',
                    'Authorization': `token ${githubToken}`
                },
                body: JSON.stringify({
                    "operation": "download",
                    "transfers": ["basic"],
                    "objects": [{ "oid": oid, "size": 0 }]
                })
            });

            if (!lfsResponse.ok) {
                const errorText = await lfsResponse.text();
                console.error('Git LFS API response error:', lfsResponse.status, lfsResponse.statusText, errorText);
                throw new Error(`Failed to get LFS download URL: ${lfsResponse.status} ${lfsResponse.statusText}.`);
            }

            const lfsData = await lfsResponse.json();
            const downloadUrl = lfsData.objects[0]?.actions?.download?.href;
            
            if (!downloadUrl) {
                 throw new Error("Could not find a valid LFS download URL.");
            }

            console.log(`Attempting to download LFS content from: ${downloadUrl}`);
            const downloadResponse = await fetch(downloadUrl, {
                headers: {
                    'Authorization': `token ${githubToken}`
                }
            });

            if (!downloadResponse.ok) {
                const errorText = await downloadResponse.text();
                console.error('LFS download response error:', downloadResponse.status, downloadResponse.statusText, errorText);
                throw new Error(`Failed to download LFS image: ${downloadResponse.status} ${downloadResponse.statusText}.`);
            }
            
            fileBlob = await downloadResponse.blob();
            // --- FIX ENDS HERE ---
        }
        else {
            const binaryString = atob(fileData.content);
            const bytes = new Uint8Array(binaryString.length);
            for (let i = 0; i < binaryString.length; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            fileBlob = new Blob([bytes], { type: 'application/octet-stream' });
        }

        if (fileExtension === 'png' || fileExtension === 'jpg' || fileExtension === 'jpeg') {
            const imgUrl = URL.createObjectURL(fileBlob);
            imageElement = new Image();
            imageElement.onload = () => {
                drawImage();
                URL.revokeObjectURL(imgUrl);
            };
            imageElement.onerror = (e) => {
                console.error("Image load error:", e);
                throw new Error("Failed to load image. It might be corrupted or in an unsupported format.");
            };
            imageElement.src = imgUrl;
        } else if (fileExtension === 'dcm' || fileExtension === 'dicom') {
            const reader = new FileReader();
            reader.onload = function(e) {
                const arrayBuffer = e.target.result;
                const byteArray = new Uint8Array(arrayBuffer);
                try {
                    const dicomImage = cornerstone.wadouri.dataSetToImage(dicomParser.parseDicom(byteArray), "file");
                    dicomImage.promise.then(function(image) {
                        imageElement = image;
                        cornerstone.enable(canvas);
                        cornerstone.fitToWindow(canvas);
                        drawImage();
                        
                        canvas.removeEventListener('mousedown', cornerstone.handleMouseDown);
                        canvas.removeEventListener('mousemove', cornerstone.handleMouseMove);
                        canvas.removeEventListener('mouseup', cornerstone.handleMouseUp);
                        canvas.removeEventListener('contextmenu', cornerstone.handleRightClick);
                        canvas.removeEventListener('wheel', cornerstone.handleMouseWheel);

                    }).catch(err => {
                        console.error("Cornerstone error:", err);
                        showMessage("Failed to render DICOM image.");
                    });
                } catch (err) {
                    console.error("DICOM parsing error:", err);
                    showMessage("Failed to parse DICOM file.");
                }
            };
            reader.readAsArrayBuffer(fileBlob);
        } else {
            throw new Error(`Unsupported image format: ${fileExtension}.`);
        }
    } catch (error) {
        console.error('An unexpected error occurred during image loading:', error);
        throw new Error(`Failed to fetch the image: ${error.message}. Please check your network connection and GitHub permissions.`);
    }
}
